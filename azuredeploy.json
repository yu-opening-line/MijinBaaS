{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "2nd_location": {
        "defaultValue": "West US",
        "type": "string",
        "allowedValues": [
          "West India",
          "Central India",
          "South India",
          "Australia East",
          "Australia Southeast",
          "Canada East",
          "Canada Central",
          "Brazil South",
          "West Europe",
          "North Europe",
          "UK West",
          "UK South",
          "Korea Central",
          "Korea South",
          "Japan West",
          "East Asia",
          "Southeast Asia",
          "Japan East",
          "West US",
          "West US 2",
          "Central US",
          "West Central US",
          "South Central US",
          "North Central US",
          "East US",
          "East US 2"
        ],
        "metadata": {
          "description": "Select 2nd Mijin Server Location. Location should be unique."
        }
    },
    "3rd_location": {
      "defaultValue": "West Europe",
      "type": "string",
      "allowedValues": [
        "West India",
        "Central India",
        "South India",
        "Australia East",
        "Australia Southeast",
        "Canada East",
        "Canada Central",
        "Brazil South",
        "West Europe",
        "North Europe",
        "UK West",
        "UK South",
        "Korea Central",
        "Korea South",
        "Japan West",
        "East Asia",
        "Southeast Asia",
        "Japan East",
        "West US",
        "West US 2",
        "Central US",
        "West Central US",
        "South Central US",
        "North Central US",
        "East US",
        "East US 2"
      ],
      "metadata": {
        "description": "Select 3rd Mijin Server Location. Location should be unique."
      }
    },
    "4th_location": {
      "defaultValue": "West India",
      "type": "string",
      "allowedValues": [
        "West India",
        "Central India",
        "South India",
        "Australia East",
        "Australia Southeast",
        "Canada East",
        "Canada Central",
        "Brazil South",
        "West Europe",
        "North Europe",
        "UK West",
        "UK South",
        "Korea Central",
        "Korea South",
        "Japan West",
        "East Asia",
        "Southeast Asia",
        "Japan East",
        "West US",
        "West US 2",
        "Central US",
        "West Central US",
        "South Central US",
        "North Central US",
        "East US",
        "East US 2"
      ],
      "metadata": {
        "description": "Select 4th Mijin Server Location. Location should be unique."
      }
    },
    "5th_location": {
      "defaultValue": "Australia East",
      "type": "string",
      "allowedValues": [
        "West India",
        "Central India",
        "South India",
        "Australia East",
        "Australia Southeast",
        "Canada East",
        "Canada Central",
        "Brazil South",
        "West Europe",
        "North Europe",
        "UK West",
        "UK South",
        "Korea Central",
        "Korea South",
        "Japan West",
        "East Asia",
        "Southeast Asia",
        "Japan East",
        "West US",
        "West US 2",
        "Central US",
        "West Central US",
        "South Central US",
        "North Central US",
        "East US",
        "East US 2"
      ],
      "metadata": {
        "description": "Select 5th Mijin Server Location. Location should be unique."
      }
    },
    "admin_user": {
        "type": "String",
        "minLength": 1,
        "maxLength": 15
    },
    "admin_password": {
        "type": "secureString",
        "minLength": 12,
        "maxLength": 72,
        "metadata": {
          "description": "Admin Password for the Mijin Server. Passwords must be between 12 and 72 characters and have 3 of the following: 1 lower case, 1 upper case, 1 number, and 1 special character."
        }
    },
    "mijin_vm_prefix": {
        "type": "String",
        "metadata": {
          "description": "Specify the server name prefix is unique. Valid only lowercase letters(a-z)."
        }
    },
    "issue_account_local_IPs": {
        "defaultValue": "",
        "type": "String",
        "metadata": {
          "description": "Set the Local IP Address to issue the Mijin Account. For more than one, enter with pipe break. (XX.XX.XX.XX | XX.XX.XX.XX)"
        }
    }
  },
  "variables": {
    "VM_DEPLOY_JSON_URL"  : "https://raw.githubusercontent.com/yu000/MijinBaaS/master/vmdeploy.json",
    "MIJIN_INSTALL_SH_URL": "https://raw.githubusercontent.com/yu000/MijinBaaS/master/scripts/install_mijin.sh",
    "MIJIN_INSTALLER_URL" : "https://mijinsolution.file.core.windows.net/mijin/mijin.0.6.93.tar.gz?st=2018-01-29T06%3A00%3A00Z&se=2099-12-31T05%3A59%3A00Z&sp=rl&sv=2016-05-31&sr=f&sig=hYqsu538oD%2FuJbcfwDN6cn7u5WA3DtG%2B4woIhyVNZsk%3D",
    "location0": "[resourceGroup().location]",
    "location1": "[parameters('2nd_location')]",
    "location2": "[parameters('3rd_location')]",
    "location3": "[parameters('4th_location')]",
    "location4": "[parameters('5th_location')]",
    "base_vm_name": "[concat(parameters('mijin_vm_prefix'),'-mijin-vm')]"
  },
  "resources": [
    {
      "name": "[concat('mijindeploy', copyIndex())]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2017-05-10",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('VM_DEPLOY_JSON_URL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "location": {
            "value": "[variables(concat('location', copyIndex()))]"
          },
          "adminUsername": {
            "value": "[parameters('admin_user')]"
          },
          "adminPassword": {
            "value": "[parameters('admin_password')]"
          },
          "mijin_vm_prefix": {
            "value": "[parameters('mijin_vm_prefix')]"
          },
          "mijin_vm_number": {
              "value": "[copyIndex()]"
          }
        }
      },
      "copy": {
        "name"  : "vm_deploy_copy",
        "count" : 5
      }
    },
    {
      "comments": "CustomScriptForLinux:install_mijin.sh",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(variables('base_vm_name'), copyIndex(), '/extension')]",
      "apiVersion": "2016-03-30",
      "location": "[variables(concat('location', copyIndex()))]",
      "properties": {
        "publisher": "Microsoft.OSTCExtensions",
        "type": "CustomScriptForLinux",
        "typeHandlerVersion": "1.0",
        "settings": {
          "fileUris": [
            "[variables('MIJIN_INSTALL_SH_URL')]"
          ],
          "commandToExecute":
            "[concat(
              'su - '
              parameters('admin_user'),
              ' -c ',
              '\"sh install_mijin.sh',
              ' ',
              parameters('issue_account_local_IPs'),
              ' ',
              reference('mijindeploy0').outputs.ret_publicIPAddress.value,
              ' ',
              reference('mijindeploy1').outputs.ret_publicIPAddress.value,
              ' ',
              reference('mijindeploy2').outputs.ret_publicIPAddress.value,
              ' ',
              reference('mijindeploy3').outputs.ret_publicIPAddress.value,
              ' ',
              reference('mijindeploy4').outputs.ret_publicIPAddress.value,
              ' \"',
              variables('MIJIN_INSTALLER_URL'),
              '\" ',
              parameters('admin_user'),
              '\"'
            )]"
        }
      },
      "copy": {
        "name"  : "mijin_install_copy",
        "count" : 5
      }
    }
  ],
  "outputs": {
  }
}
