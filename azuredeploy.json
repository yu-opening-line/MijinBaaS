{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "2nd_location": {
        "type": "string",
        "allowedValues": [
          "West India",
          "Central India",
          "South India",
          "Australia East",
          "Australia Southeast",
          "Canada East",
          "Canada Central",
          "Brazil South",
          "West Europe",
          "North Europe",
          "UK West",
          "UK South",
          "Korea Central",
          "Korea South",
          "Japan West",
          "East Asia",
          "Southeast Asia",
          "Japan East",
          "West US",
          "West US 2",
          "Central US",
          "West Central US",
          "South Central US",
          "North Central US",
          "East US",
          "East US 2"
        ],
        "metadata": {
          "description": "Select 2nd Mijin Server Location."
        }
    },
    "3rd_location": {
      "type": "string",
      "allowedValues": [
        "West India",
        "Central India",
        "South India",
        "Australia East",
        "Australia Southeast",
        "Canada East",
        "Canada Central",
        "Brazil South",
        "West Europe",
        "North Europe",
        "UK West",
        "UK South",
        "Korea Central",
        "Korea South",
        "Japan West",
        "East Asia",
        "Southeast Asia",
        "Japan East",
        "West US",
        "West US 2",
        "Central US",
        "West Central US",
        "South Central US",
        "North Central US",
        "East US",
        "East US 2"
      ],
      "metadata": {
        "description": "Select 3rd Mijin Server Location."
      }
    },
    "4th_location": {
      "type": "string",
      "allowedValues": [
        "West India",
        "Central India",
        "South India",
        "Australia East",
        "Australia Southeast",
        "Canada East",
        "Canada Central",
        "Brazil South",
        "West Europe",
        "North Europe",
        "UK West",
        "UK South",
        "Korea Central",
        "Korea South",
        "Japan West",
        "East Asia",
        "Southeast Asia",
        "Japan East",
        "West US",
        "West US 2",
        "Central US",
        "West Central US",
        "South Central US",
        "North Central US",
        "East US",
        "East US 2"
      ],
      "metadata": {
        "description": "Select 4th Mijin Server Location."
      }
    },
    "adminPassword": {
        "type": "secureString",
        "metadata": {
          "description": "Password for the 1st Mijin Server."
        }
    },
    "2nd_server_admin_password": {
        "type": "secureString",
        "metadata": {
          "description": "Password for the 2nd Mijin Server."
        }
    },
    "3rd_server_admin_password": {
        "type": "secureString",
        "metadata": {
          "description": "Password for the 3rd Mijin Server."
        }
    },
    "4th_server_admin_password": {
        "type": "secureString",
        "metadata": {
          "description": "Password for the 4th Mijin Server."
        }
    },
    "mijin_vm_prefix": {
        "type": "String",
        "minLength": 1,
        "metadata": {
          "description": "Unique Server Name. "
        }
    },
    "additional_local_IPs": {
        "defaultValue": "182.236.21.55",
        "type": "String"
    }
  },
  "variables": {
    "VM_DEPLOY_JSON_URL"  : "https://raw.githubusercontent.com/yu000/MijinBaaS/master/vmdeploy.json",
    "MIJIN_INSTALL_SH_URL": "https://raw.githubusercontent.com/yu000/MijinBaaS/master/scripts/install_mijin.sh",
    "MIJIN_INSTALLER_URL" : "https://raw.githubusercontent.com/yu000/MijinBaaS/master/scripts/m.tar.gz",
    "location0": "[resourceGroup().location]",
    "location1": "[parameters('2nd_location')]",
    "location2": "[parameters('3rd_location')]",
    "location3": "[parameters('4th_location')]",
    "adminPassword0": "[parameters('1st_server_admin_password')]",
    "adminPassword1": "[parameters('2nd_server_admin_password')]",
    "adminPassword2": "[parameters('3rd_server_admin_password')]",
    "adminPassword3": "[parameters('4th_server_admin_password')]",
    "base_vm_name": "[concat(parameters('mijin_vm_prefix'),'-mijin-vm')]"
  },
  "resources": [
    {
      "name": "[concat('mijindeploy', copyIndex())]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2017-05-10",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('VM_DEPLOY_JSON_URL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "location": {
            "value": "[variables(concat('location', copyIndex()))]"
          },
          "adminPassword": {
            "value": "[variables(concat('adminPassword', copyIndex()))]"
          },
          "mijin_vm_prefix": {
            "minLength": 1,
            "value": "[parameters('mijin_vm_prefix')]"
          },
          "mijin_vm_number": {
              "value": "[copyIndex()]"
          }
        }
      },
      "copy": {
        "name"  : "vm_deploy_copy",
        "count" : 4
      }
    },
    {
      "comments": "リソース '/subscriptions//resourceGroups/cent-rg/providers/Microsoft.Compute/virtualMachines/centostest01/extensions/CustomScriptForLinux' 㝋ら一般化㝕れ㝾㝗㝟。",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(variables('base_vm_name'), copyIndex(), '/extension')]",
      "apiVersion": "2016-03-30",
      "location": "[variables(concat('location', copyIndex()))]",
      "properties": {
        "publisher": "Microsoft.OSTCExtensions",
        "type": "CustomScriptForLinux",
        "typeHandlerVersion": "1.0",
        "settings": {
          "fileUris": [
            "[variables('MIJIN_INSTALL_SH_URL')]"
          ],
          "commandToExecute":
            "[concat('sh install_mijin.sh',
              ' ',
              variables('MIJIN_INSTALLER_URL'),
              ' ',
              parameters('add_itional_local_IPs'),
              ' ',
              reference('mijindeploy0').outputs.ret_publicIPAddress.value,
              ' ',
              reference('mijindeploy1').outputs.ret_publicIPAddress.value,
              ' ',
              reference('mijindeploy2').outputs.ret_publicIPAddress.value,
              ' ',
              reference('mijindeploy3').outputs.ret_publicIPAddress.value
            )]"
        }
      },
      "copy": {
        "name"  : "mijin_install_copy",
        "count" : 4
      }
    }
  ],
  "outputs": {
  }
}
