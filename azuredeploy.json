{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "2nd_location": {
        "defaultValue": "West US",
        "type": "string",
        "allowedValues": [
          "West India",
          "Central India",
          "South India",
          "Australia East",
          "Australia Southeast",
          "Canada East",
          "Canada Central",
          "Brazil South",
          "West Europe",
          "North Europe",
          "UK West",
          "UK South",
          "Korea Central",
          "Korea South",
          "Japan West",
          "East Asia",
          "Southeast Asia",
          "Japan East",
          "West US",
          "West US 2",
          "Central US",
          "West Central US",
          "South Central US",
          "North Central US",
          "East US",
          "East US 2"
        ],
        "metadata": {
          "description": "Select 2nd Mijin Server Location."
        }
    },
    "3rd_location": {
      "defaultValue": "West Europe",
      "type": "string",
      "allowedValues": [
        "West India",
        "Central India",
        "South India",
        "Australia East",
        "Australia Southeast",
        "Canada East",
        "Canada Central",
        "Brazil South",
        "West Europe",
        "North Europe",
        "UK West",
        "UK South",
        "Korea Central",
        "Korea South",
        "Japan West",
        "East Asia",
        "Southeast Asia",
        "Japan East",
        "West US",
        "West US 2",
        "Central US",
        "West Central US",
        "South Central US",
        "North Central US",
        "East US",
        "East US 2"
      ],
      "metadata": {
        "description": "Select 3rd Mijin Server Location."
      }
    },
    "4th_location": {
      "defaultValue": "Australia East",
      "type": "string",
      "allowedValues": [
        "West India",
        "Central India",
        "South India",
        "Australia East",
        "Australia Southeast",
        "Canada East",
        "Canada Central",
        "Brazil South",
        "West Europe",
        "North Europe",
        "UK West",
        "UK South",
        "Korea Central",
        "Korea South",
        "Japan West",
        "East Asia",
        "Southeast Asia",
        "Japan East",
        "West US",
        "West US 2",
        "Central US",
        "West Central US",
        "South Central US",
        "North Central US",
        "East US",
        "East US 2"
      ],
      "metadata": {
        "description": "Select 4th Mijin Server Location."
      }
    },
    "admin_password": {
        "type": "secureString",
        "minLength": 12,
        "maxLength": 72,
        "metadata": {
          "description": "Password for the Mijin Server. Passwords must be between 12 and 72 characters and have 3 of the following: 1 lower case, 1 upper case, 1 number, and 1 special character."
        }
    },
    "mijin_vm_prefix": {
        "defaultValue": "m",
        "type": "String",
        "metadata": {
          "description": "Unique Server Name."
        }
    },
    "additional_local_IPs": {
        "defaultValue": "",
        "type": "String",
        "metadata": {
          "description": "Set the Local IP Address to issue the Mijin Account. For more than one, enter with pipe break. (XX.XX.XX.XX | XX.XX.XX.XX)"
        }
    }
  },
  "variables": {
    "VM_DEPLOY_JSON_URL"  : "https://raw.githubusercontent.com/yu000/MijinBaaS/master/vmdeploy.json",
    "MIJIN_INSTALL_SH_URL": "https://raw.githubusercontent.com/yu000/MijinBaaS/master/scripts/install_mijin.sh",
    "MIJIN_VHD_URL"       : "https://mmijinvm0disks.blob.core.windows.net/system/Microsoft.Compute/Images/mijinvm/m-osDisk.dbd20053-74aa-40da-a191-56b121ddbf8e.vhd",
    "location0": "[resourceGroup().location]",
    "location1": "[parameters('2nd_location')]",
    "location2": "[parameters('3rd_location')]",
    "location3": "[parameters('4th_location')]",
    "base_vm_name": "[concat(parameters('mijin_vm_prefix'),'-mijin-vm')]"
  },
  "resources": [
    {
      "name": "[concat('mijindeploy', copyIndex())]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2017-05-10",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('VM_DEPLOY_JSON_URL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "location": {
            "value": "[variables(concat('location', copyIndex()))]"
          },
          "adminPassword": {
            "value": "[parameters('admin_password')]"
          },
          "mijin_vm_prefix": {
            "value": "[parameters('mijin_vm_prefix')]"
          },
          "mijin_vm_number": {
              "value": "[copyIndex()]"
          },
          "mijin_vhd_url": {
            "value": "[variables('MIJIN_VHD_URL')]"
          }
        }
      },
      "copy": {
        "name"  : "vm_deploy_copy",
        "count" : 4
      }
    },
    {
      "comments": "リソース '/subscriptions//resourceGroups/cent-rg/providers/Microsoft.Compute/virtualMachines/centostest01/extensions/CustomScriptForLinux' 㝋ら一般化㝕れ㝾㝗㝟。",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(variables('base_vm_name'), copyIndex(), '/extension')]",
      "apiVersion": "2016-03-30",
      "location": "[variables(concat('location', copyIndex()))]",
      "properties": {
        "publisher": "Microsoft.OSTCExtensions",
        "type": "CustomScriptForLinux",
        "typeHandlerVersion": "1.0",
        "settings": {
          "fileUris": [
            "[variables('MIJIN_INSTALL_SH_URL')]"
          ],
          "commandToExecute":
            "[concat('sh install_mijin.sh',
              ' ',
              parameters('additional_local_IPs'),
              ' ',
              reference('mijindeploy0').outputs.ret_publicIPAddress.value,
              ' ',
              reference('mijindeploy1').outputs.ret_publicIPAddress.value,
              ' ',
              reference('mijindeploy2').outputs.ret_publicIPAddress.value,
              ' ',
              reference('mijindeploy3').outputs.ret_publicIPAddress.value
            )]"
        }
      },
      "copy": {
        "name"  : "mijin_install_copy",
        "count" : 4
      }
    }
  ],
  "outputs": {
  }
}
